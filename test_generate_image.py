import os
import requests
import random
import time
import datetime
import base64
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
load_dotenv()

OAUTH_TOKEN = os.getenv("OAUTH_TOKEN")
CATALOG_ID = os.getenv("CATALOG_ID")
# IAM_TOKEN = os.getenv("IAM_TOKEN")
client = openai.OpenAI(api_key="sk-...")


def get_iam_token(oauth_token):
    url = "https://iam.api.cloud.yandex.net/iam/v1/tokens"
    response = requests.post(
        url,
        json={"yandexPassportOauthToken": oauth_token}
    )
    if response.status_code == 200:
        return response.json()["iamToken"]
    else:
        raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ IAM_TOKEN: {response.status_code} {response.text}")

# –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π IAM_TOKEN –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—É—Å–∫–æ–º
IAM_TOKEN = get_iam_token(OAUTH_TOKEN)
print(f"IAM_TOKEN: {IAM_TOKEN[:10]}...")  # –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ, —á—Ç–æ–±—ã –Ω–µ —Å–≤–µ—Ç–∏—Ç—å –≤–µ—Å—å)



ABC = "—É–∑–æ—Ä –∏–∑ —Ü–≤–µ—Ç–Ω—ã—Ö –ø–∞—Å—Ç–µ–ª—å–Ω—ã—Ö —Å—É–∫–∫—É–ª–µ–Ω—Ç–æ–≤ —Ä–∞–∑–Ω—ã—Ö —Å–æ—Ä—Ç–æ–≤, hd full wallpaper, —á–µ—Ç–∫–∏–π —Ñ–æ–∫—É—Å, –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–ª–æ–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π, –≥–ª—É–±–∏–Ω–∞ –∫–∞–¥—Ä–∞, –≤–∏–¥ —Å–≤–µ—Ä—Ö—É"
A1 = "—Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ–¥ –Ω–æ—á—å—é, —Å–∏—è—é—â–∏–µ –Ω–µ–æ–Ω–æ–≤—ã–µ –≤—ã–≤–µ—Å–∫–∏, –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –º–æ–∫—Ä–æ–º –∞—Å—Ñ–∞–ª—å—Ç–µ, –æ–≥—Ä–æ–º–Ω—ã–µ –Ω–µ–±–æ—Å–∫—Ä—ë–±—ã, –∫–∏–±–µ—Ä–ø–∞–Ω–∫ —Å—Ç–∏–ª—å, –º–Ω–æ–≥–æ –¥–µ—Ç–∞–ª–µ–π, –≤–∏–¥ —Å–≤–µ—Ä—Ö—É"
A2 = "—è—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π —Ä–µ—Ç—Ä–æ-–∫–∞–±—Ä–∏–æ–ª–µ—Ç –Ω–∞ –ø–æ–±–µ—Ä–µ–∂—å–µ, —Å—Ç–∏–ª—å 1960-—Ö, –≥–æ–ª—É–±–æ–µ –Ω–µ–±–æ, –º—è–≥–∫–æ–µ —Å–æ–ª–Ω–µ—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ —Å–≤–æ–±–æ–¥—ã"
A3 = "–≤–æ–ª—à–µ–±–Ω—ã–π –ª–µ—Å –Ω–∞ —Ä–∞—Å—Å–≤–µ—Ç–µ, —Ç—É–º–∞–Ω –º–µ–∂–¥—É –¥–µ—Ä–µ–≤—å—è–º–∏, –ª—É—á–∏ —Å–≤–µ—Ç–∞, –º–æ—Ö, –±–æ–ª—å—à–∏–µ —Å—Ç–∞—Ä—ã–µ –¥–µ—Ä–µ–≤—å—è, —Å–∫–∞–∑–æ—á–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ"
A4 = "–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—ã, –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞, –±–µ–ª—ã–π —Ñ–æ–Ω, —á–∏—Å—Ç—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å"
A5 = "–ø–æ—Ä—Ç—Ä–µ—Ç —Å–æ–≤—ã –≤ —Å—Ç–∏–ª–µ –∞–∫–≤–∞—Ä–µ–ª–∏, –∫—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω, –º—è–≥–∫–∏–µ —Ü–≤–µ—Ç–∞, –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ –≥–ª–∞–∑–∞, —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–æ–Ω"
A6 = "—Ñ—ç–Ω—Ç–µ–∑–∏-–∑–∞–º–æ–∫ –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ —Å–∫–∞–ª—ã, –æ–±–ª–∞–∫–∞ –≤–Ω–∏–∑—É, —Ä–æ–∑–æ–≤–æ–µ –Ω–µ–±–æ, –¥—Ä–∞–∫–æ–Ω –ª–µ—Ç–∏—Ç –≤–¥–∞–ª–µ–∫–µ, –º–Ω–æ–≥–æ —Å–≤–µ—Ç–∞ –∏ —Ç–µ–Ω–∏, —ç–ø–∏—á–µ—Å–∫–∞—è —Å—Ü–µ–Ω–∞"
A7 = "–ø–∞—Ä–æ–≤–æ–∑, –µ–¥—É—â–∏–π –ø–æ —Ä–µ–ª—å—Å–∞–º —Å–∫–≤–æ–∑—å –ø–æ—Ä—Ç–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏, –ø–µ–π–∑–∞–∂ –º–µ–Ω—è–µ—Ç—Å—è –æ—Ç –¥—Ä–µ–≤–Ω–∏—Ö –≤—Ä–µ–º—ë–Ω –¥–æ —Ñ—É—Ç—É—Ä–∏–∑–º–∞, –¥–∏–Ω–∞–º–∏–∫–∞, —Å–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç—ã"
A8 = "—Ä–æ–±–æ—Ç-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –ø–ª–∞–Ω–µ—Ç—ã, –∑–≤—ë–∑–¥—ã –Ω–∞ —Ñ–æ–Ω–µ, –∑–∞–≥–∞–¥–æ—á–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –Ω–∞—É—á–Ω–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞"


# 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
load_dotenv()

IAM_TOKEN = os.getenv("IAM_TOKEN")
CATALOG_ID = os.getenv("CATALOG_ID")

if not IAM_TOKEN or not CATALOG_ID:
    raise ValueError("–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω IAM_TOKEN –∏–ª–∏ CATALOG_ID –≤ .env!")

# 2. –ì–æ—Ç–æ–≤–∏–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
url = "https://llm.api.cloud.yandex.net/foundationModels/v1/imageGenerationAsync"

headers = {
    "Authorization": f"Bearer {IAM_TOKEN}",
    "Content-Type": "application/json"
}

data = {
    "modelUri": f"art://{CATALOG_ID}/yandex-art/latest",
    "generationOptions": {
        "seed": str(random.randint(0, 1000000)),
        # seed - –∑–µ—Ä–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –ª—é–±–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ (2 [–≤ —Å—Ç–µ–ø–µ–Ω–∏ 63] –º–∏–Ω—É—Å 1)
        # –ø—Ä–∏ –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ –ø—Ä–æ–º—Ç–µ –∏ –∑–µ—Ä–Ω–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±—É–¥–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º
        "aspectRatio": {
            "widthRatio": "2",
            "heightRatio": "1"
        }
    },
    "messages": [
        {
            "weight": "1",
            # "text" : " –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ú–ü–¢–ê "
            "text": A3
        }
    ]
}

# 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
response = requests.post(url, headers=headers, json=data)

if response.status_code == 200:
    request_id = response.json().get('id')
    print(f"üü¢ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. ID: {request_id}")

    # 4. –ñ–¥–µ–º, –∑–∞—Ç–µ–º –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    time.sleep(10)  # –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å, –µ—Å–ª–∏ —á–∞—Å—Ç–æ –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç

    # Headers –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (Content-Type –Ω–µ –Ω—É–∂–µ–Ω)
    headers_check = {
        "Authorization": f"Bearer {IAM_TOKEN}"
    }

    url_check = f"https://llm.api.cloud.yandex.net/operations/{request_id}"
    response_check = requests.get(url_check, headers=headers_check)

    if response_check.status_code == 200:
        resp_json = response_check.json()
        print(resp_json)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç–µ
        try:
            image_base64 = resp_json['response']['image']
            image_data = base64.b64decode(image_base64)
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
            timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
            filename = f"image_{timestamp}.jpeg"

            with open(filename, 'wb') as file:
                file.write(image_data)
            print(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ {filename}")
        except (KeyError, TypeError):
            print("‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–æ –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è.")
            print(resp_json)
    else:
        print(f"–û—à–∏–±–∫–∞: {response_check.status_code} - {response_check.text}")
else:
    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {response.status_code} - {response.text}")
